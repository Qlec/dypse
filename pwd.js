/*
** Licensed under GNU GPL v3.0
** Copyright (C) 2022, qlec
** v4 algorithm
*/

let extraPhrase="";async function generatePassword(a,b,c,d,e,f,g,h,i){async function j(a){const b=new TextEncoder().encode(a),c=await crypto.subtle.digest("SHA-384",b),d=Array.from(new Uint8Array(c));return d}async function k(a,b){void 0!==b&&(a=l(a,b));const c=new TextEncoder().encode(a),d=await crypto.subtle.digest("SHA-384",c),e=Array.from(new Uint8Array(d)),f=e.map(a=>a.toString(16).padStart(2,"0")).join("");return f}async function l(a,b){let c=new Uint32Array(a.length),d="";for(let d=0;d<a.length;d++)c[d]=a.charCodeAt(d)+2713*(await m(b));for(let e=0;e<c.length;e++)d+=String.fromCharCode(c[e]);return d}async function m(a){let b=await j((await k(a))+(await k(p))),c=temp3="";p+=18517;for(let d=0;3>d;d++){for(temp3=b[d].toString(2)+"";8>temp3.length;)temp3="0"+temp3;c+=temp3+""}return c="0"+c,c=(c+"").slice(0,18),(111111111111111100*(1/Math.pow(2,52)*+(c>>>3))%1+"").slice(0,18)}async function n(a){for(let b=0;b<a;b++)q=await k(q);s.b=await s.b.shuffle()}async function o(a,b){String.prototype.testRegExp=function(a,b){for(let c=tmp2=0;c<this.length;)-1<this.charAt(c).search(a)&&tmp2++,c++;return!!(tmp2>b-1)};let c=b;for(let d in a)if(await n(3e3),-1==b.search(a[d])){let e,f=0;for(;4>f;){if(s.a.includes(s.c[d])&&b.testRegExp(a[f],2)){e=f;break}f++}c=c.replace(a[e],s.c[d].charAt(await m(q)))}return c}let p=0,q=(await k(a,101))+(await k(b,103))+(await k(c,107))+(await k(d,109))+(await k(i,113))+(await k(extraPhrase,127));String.prototype.shuffle=async function(){let b=this.split(""),a=b.length;for(let c=a-1;0<c;c--){let a=Math.floor((await m())*(c+1)),d=b[c];b[c]=b[a],b[a]=d}return b.join("")};let r="",s={a:"",b:"",c:["abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ","1234567890","!@#$%^&*()~{}[]"]};if(0<e+f+g+h)e&&(s.b+=s.c[0]),f&&(s.b+=s.c[1]),g&&(s.b+=s.c[2]),h&&(s.b+=s.c[3]),s.a=s.b;else throw new Error("A category must be selected");await n(1e5);let t;for(let j=0;j<d;j++)await n(3e3),p+=9311*(await m(q)),t=Math.floor((await m(q))*s.b.length),r+=s.b[t];return r=await o([/[a-z]/,/[A-Z]/,/[0-9]/,/[!@#$%^&*()~{}\[\]]/],r),await n(1e3),r}async function createPassword(){function a(a){return+document.getElementById(a).checked}function b(a){warning.innerHTML=a,warning.style.display="block",document.getElementsByClassName("notice")[0].innerHTML="uh-oh"}generateBtn.setAttribute("disabled",""),warning.style.display="none",warning.innerHTML="",document.getElementsByClassName("notice")[0].innerHTML=FLAVOR_TEXT[Math.floor(Math.random()*FLAVOR_TEXT.length)]+"...",setTimeout(async function(){try{let c=await generatePassword(site.value,masterPwd.value,pin.value,document.getElementById("length").value,a("lower"),a("upper"),a("numbers"),a("symbols"),identifier.value);document.getElementsByClassName("notice")[0].innerHTML="Done!",navigator.clipboard.writeText(c).catch(()=>{b("Error: Failed to copy password to clipboard. Make sure you're focused on this window.","Failed to copy password.")})}catch(a){b(a,a)}document.getElementById("generateBtn").removeAttribute("disabled")},1)}document.body.onload=function(){function a(a){for(let b of location.search.slice(1).split("&"))if(b.includes(a+"="))return decodeURIComponent(b.slice(a.length+1));return""}site.value=a("u"),identifier.value=a("i"),extraPhrase=a("e")};
